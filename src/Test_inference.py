# Thomas Vikström, 2025-11-11 21:12
# This version lets you test your EI model using either live EEG or a pasted processed-feature vector.

import numpy as np
from tensorflow.keras.models import load_model

# === CONFIG ===
USE_EI_FEATURES = True   # ← Set True to bypass DSP and use EI features directly
MODEL_PATH = "model.h5"  # or your local EI-exported model
# Paste one line of processed features from Edge Impulse below:
EI_FEATURE_VECTOR = [

-0.1721, 0.0342, -0.3211, -0.8968, -0.8996, -0.2489, -0.1548, -0.6430, -0.3429, 0.5184, -1.7688, 0.5992, -0.0940, 0.8959, -0.4197, -0.1919, 0.2152, 0.4569, -0.1856, -0.1561, 0.3058, -0.4199, 0.6197, -0.4185, 0.0971, -0.4537, 0.2693, -0.6464, -0.0543, -0.0930, -0.3379, 0.0841, -0.0612, 0.1297, -0.0655, -0.3478, -0.6328, -0.0761, -0.9492, -0.2713, 0.2559, 0.0491, 0.3693, 0.5902, -0.0484, 0.5599, -0.2378, 0.5249, -0.0646, -0.1038, -0.5888, -0.1369, 0.5449, 0.1576, 0.0541, 0.1525, 0.5289, -0.5521, -0.7159, 0.1821, -0.2366, -0.2195, -0.6408, 0.6446, -0.0636, 0.5953, 0.4967, 0.2332, -0.3162, -0.8861, -0.7636, 0.0292, -0.5081, 0.4782, -0.0168, 0.0480, -0.8946, -1.0189, -1.3879, -0.1543, -0.5873, -0.9785, -0.1438, -0.4952, 0.3369, -0.0290, 0.5594, -0.5442, 0.1964, -0.3748, -0.3165, 0.0957, 0.2724, 0.2515, 0.3402, -0.2084, -1.2650, -0.2808, 0.1442, -0.8450, -0.8741, -0.1916, 0.4318, 0.1806, 0.3370, 1.3297, 0.8668, -0.2041, -0.5162, -0.2500, -1.1100, -0.7429, 0.1899, -0.4289, 0.9781, -0.2279, 0.3604, 0.0597, -1.6209, 0.2355, 0.1802, -0.4736, 0.4845, 1.3893, 0.3809, -0.0849, -0.5417, 0.4796, -0.2133, 0.4579, 0.1860, -0.7881, -1.4447, -0.2967, -0.4225, -0.3979, -0.1133, -0.0786, 0.1466, -0.7379, 0.1675, -1.3951, -0.8163, 0.5066, -0.3206, -0.7519, -0.8386, -0.3406, 0.5844, 0.4113, -0.3349, 0.2854, -0.8928, -0.1525, -0.6469, 0.6556, -0.7335, 0.2447, -1.1629, -0.0323, -0.4805, -0.6314, -1.2342, -0.8474, -0.4288, 0.0641, 0.0088, 0.3388, -1.6442, -0.2357, 0.1998, -0.3317, 0.1936, 0.1527, -0.3491, 0.3041, 0.4594, -0.0088, 0.5092, -0.1444, 0.3486, -0.1350, -0.0933, -0.6238, -0.2663, 0.2726, 0.1038, 0.0253, 0.1110, -0.1338, -0.5978, -0.7892, 0.0966, -0.4045, -0.0252, -0.2727, 0.5141, 0.0687, 0.4673, 0.1399, 0.0640, -0.3235, -1.0421, -0.8801, -0.2305, 0.4977, 0.0440, -0.1312, 0.0931, -0.3418, -0.4460, -0.9366, 0.0077, -0.6757, -0.0741, 0.0164, -0.6635, -0.1002, 0.1954, 0.5100, -0.1074, -0.0158, -0.7131, -0.9198, -0.1566, 0.1802, 0.6665, 0.0924, 0.0872, -0.5833, -0.4121, -0.1927, -0.5818, -0.6483, -0.0719, 0.1544, 0.1907, 0.0677, 0.9073, 0.8099, 0.1138, -0.8940, -0.3790, 0.0496, -0.2033, 0.2206, -0.3714, 0.7096, 0.1150, 0.4668, -0.7258, -0.5662, 0.0642, 0.3693, 0.4758, 0.2531, 0.3357, 0.2790, -0.5109, -0.8606, -0.8982, -0.4310, -0.4021, -0.3722, -0.6531, -1.4827, -0.4213, 0.0288, -0.7659, 0.2956, 0.4320, -0.7966, -1.3944, -1.3598, -1.5064, -0.7044, -0.9809, 0.1633, -0.8615, -1.9491, -0.2822, -0.7992, 0.0070, -0.0285, -0.6809, -1.0374, -0.0399, -0.3157, -0.1225, -0.0698, 0.5544, -1.1509, 0.4263, -0.5862, -0.5926, -3.3695, -1.3452, 0.5174, -0.0820, 0.1082, -0.2895, -0.1573, -0.6529, 0.2364, 0.3541, 0.2758, -0.4069, 0.0111, 0.3368, 0.8681, -0.0168, 0.4780, -0.0568, 0.9940, 0.1604, 0.1748, 0.0378, 0.8624, 0.5311, 0.4492, 0.2318, 0.4401, 0.6127, -1.1419, -0.2866, 0.6776, -0.3906, 0.3990, 0.0793, 0.6387, 0.2956, 0.5722, 0.5871, 0.1951, -0.9684, -1.1432, -0.4059, -0.0420, 0.5002, -0.0224, -0.5904, 0.4348, 0.2253, -1.2709, -0.8723, -1.6461, -0.7937, 0.2840, 0.6934, -0.7327, -0.5278, -0.3856, 0.4018, -0.2809, 0.0782, -1.1773, -0.6376, 0.5710, 0.4573, 0.6251, 0.3490, 0.7367, -0.7024, -0.0085, 0.4867, -0.3375, -0.1818, -0.4148, 0.5430, 0.3869, 0.4419, 1.3484, 0.8079, -0.6973, -0.3263, -0.3425, -1.2245, -0.4167, -0.3850, -0.5984, 1.2319, -0.2140, 0.7882, -0.1298, -0.6984, -1.6339, -0.0427, 0.1317, -0.0497, 0.1955, -0.7402, -0.2276, -1.2840, -0.9009, -0.1574, -0.7919, -0.4248, 0.3347, -0.2462, -0.1356, 0.0850, -0.4072, -0.6726, -0.6716, -0.5018, 0.0305, -0.5471, -0.5890, 0.0874, -0.6244, 0.7624, 0.4423, 0.9400, -0.4274, 0.2861, 0.6519, 0.6842, -0.4319, 0.1440, 0.2307, -0.7561, 0.6659, -0.1808, 0.0269, -0.3253, 0.3211, -0.5208, -0.1684, -0.0035, -0.1982, 0.4090, -0.0031, 0.1341, -0.1248, -0.3050, -0.8368, -0.0560, -1.2058, -0.3781, 0.4069, 0.1257, 0.4607, 0.6698, -0.1007, 0.6329, -0.2541, 0.5331, -0.3586, -0.1324, -0.5067, -0.3506, 0.6782, 0.1642, 0.0604, 0.0778, 0.5400, -0.6831, -0.6191, 0.3024, -0.5796, -0.3672, -0.6625, 0.6743, -0.0594, 0.6654, 0.5491, 0.1387, -0.3323, -0.9226, -0.4467, 0.4565, -0.7258, 0.6808, -0.0396, -0.0631, -2.0097, -0.3898, -0.3920, -0.4593, -0.2018, -1.3289, -0.1576, 0.0557, 0.4514, -0.2451, 0.4138, 0.1713, 0.2164, -0.4009, -0.9867, 0.3348, 0.3618, 0.2070, 0.4776, -0.3432, -0.8586, -0.2024, 0.1962, -0.9512, -0.7870, -0.2256, 0.5731, 0.1793, 0.6120, 1.4017, 0.7282, -0.5096, -0.6848, 0.0359, -1.1726, -0.6637, 0.1947, -0.4263, 0.9963, -0.2863, 0.3181, 0.2267, -2.3311, 0.1590, 0.0011, -0.6939, 0.5807, 1.2660, 0.5094, 0.0288, -0.7770, 0.3103, -0.4754, 0.3372, 0.1780, -1.2650, -1.1898
]


def run_inference_with_ei_features(model_path, features):
    """Runs inference on a pasted Edge Impulse processed feature vector."""
    model = load_model(model_path)
    print("Model input shape:", model.input_shape)
    print("Number of features given:", len(EI_FEATURE_VECTOR))
    print("Feature min/max:", np.min(EI_FEATURE_VECTOR), np.max(EI_FEATURE_VECTOR))


    # # --- Normalize feature vector ---
    #features = np.array(EI_FEATURE_VECTOR, dtype=np.float32)
    #features = (features - np.min(features)) / (np.max(features) - np.min(features))  # scale 0–1
    features = np.expand_dims(features, axis=0)



    pred = model.predict(features)
    print("\n=== Edge Impulse Feature Test ===")
    print("Raw probabilities:", np.round(pred[0], 3))
    print("Predicted class index:", np.argmax(pred))
    return pred




# === MAIN ===
if USE_EI_FEATURES:
    run_inference_with_ei_features(MODEL_PATH, EI_FEATURE_VECTOR)
else:
    # Normal path: run your EEG → DSP → model inference
    from spectral_analysis import generate_features
    from some_module import get_latest_eeg_window  # placeholder for your EEG input

    eeg_window = get_latest_eeg_window()
    features = generate_features(eeg_window)
    model = load_model(MODEL_PATH)
    pred = model.predict(np.expand_dims(features, axis=0))
    print("Live EEG inference:", pred)
